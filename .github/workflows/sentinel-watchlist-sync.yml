name: Sync Sentinel Watchlist from CSV

on:
  push:
    branches:
      - main
    paths:
      - maintenance.csv

permissions:
  id-token: write
  contents: read

jobs:
  sync-watchlist:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Sync Watchlist Items
        run: |
          API_VERSION="2024-09-01"
          SUB="${{ vars.AZURE_SUBSCRIPTION_ID }}"
          RG="${{ vars.RG_NAME }}"
          WORKSPACE="${{ vars.WORKSPACE_NAME }}"
          WATCHLIST_ALIAS="device_maintainance_list"
          
          BASE_URL="https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.OperationalInsights/workspaces/$WORKSPACE/providers/Microsoft.SecurityInsights/watchlists/$WATCHLIST_ALIAS"
          
          echo "Starting watchlist sync..."
          
          # Step 1: Delete all existing items
          echo "Deleting old items..."
          ITEMS_URL="$BASE_URL/watchlistItems?api-version=$API_VERSION"
          EXISTING_ITEMS=$(az rest --method get --url "$ITEMS_URL" --query 'value[].name' -o tsv 2>/dev/null || echo "")
          
          for ITEM_ID in $EXISTING_ITEMS; do
            DELETE_URL="$BASE_URL/watchlistItems/$ITEM_ID?api-version=$API_VERSION"
            az rest --method delete --url "$DELETE_URL" 2>/dev/null || true
          done
          
          echo "Old items deleted"
          
          # Step 2: Add new items from CSV
          echo "Adding new items..."
          
          sed 's/\r$//' maintenance.csv | tail -n +2 | grep -v '^[[:space:]]*$' | while IFS=, read -r hostname start_utc end_utc comment; do
            hostname=$(echo "$hostname" | xargs)
            start_utc=$(echo "$start_utc" | xargs)
            end_utc=$(echo "$end_utc" | xargs)
            comment=$(echo "$comment" | xargs)
            
            if [ -z "$hostname" ]; then
              continue
            fi
            
            ITEM_ID=$(uuidgen)
            ITEM_URL="$BASE_URL/watchlistItems/$ITEM_ID?api-version=$API_VERSION"
            
            BODY=$(jq -n \
              --arg hostname "$hostname" \
              --arg start "$start_utc" \
              --arg end "$end_utc" \
              --arg comment "$comment" \
              '{
                properties: {
                  itemsKeyValue: {
                    hostname: $hostname,
                    start_utc: $start,
                    end_utc: $end,
                    comment: $comment
                  }
                }
              }')
            
            az rest --method put --url "$ITEM_URL" \
              --headers "Content-Type=application/json" \
              --body "$BODY" >/dev/null 2>&1
            
            if [ $? -eq 0 ]; then
              echo "  Added: $hostname"
            else
              echo "  Failed: $hostname"
            fi
          done
          
          echo "Sync completed! Items are now visible in the portal."
