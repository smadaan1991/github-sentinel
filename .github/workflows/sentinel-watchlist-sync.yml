name: Sync Sentinel Watchlist from CSV

on:
  push:
    branches:
      - main
    paths:
      - maintenance.csv

permissions:
  id-token: write
  contents: read

jobs:
  sync-watchlist:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Complete Watchlist Sync
        run: |
          API_VERSION="2024-09-01"
          SUB="${{ vars.AZURE_SUBSCRIPTION_ID }}"
          RG="${{ vars.RG_NAME }}"
          WORKSPACE="${{ vars.WORKSPACE_NAME }}"
          WATCHLIST_ALIAS="device_maintainance_list"
          
          BASE_URL="https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.OperationalInsights/workspaces/$WORKSPACE/providers/Microsoft.SecurityInsights/watchlists/$WATCHLIST_ALIAS"
          
          # Step 1: Get current CSV hostnames
          echo "üìã Reading CSV hostnames..."
          CSV_HOSTS=$(tail -n +2 maintenance.csv | cut -d',' -f1 | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
          
          # Step 2: Get existing watchlist items
          echo "üîç Fetching existing items..."
          ITEMS_URL="$BASE_URL/watchlistItems?api-version=$API_VERSION"
          EXISTING_ITEMS=$(az rest --method get --url "$ITEMS_URL" --query 'value[].name' -o tsv)
          
          # Step 3: Delete items NOT in CSV
          echo "üóëÔ∏è  Removing old items..."
          for ITEM_ID in $EXISTING_ITEMS; do
            if ! echo "$CSV_HOSTS" | grep -q "^$ITEM_ID$"; then
              echo "  Deleting: $ITEM_ID"
              DELETE_URL="$BASE_URL/watchlistItems/$ITEM_ID?api-version=$API_VERSION"
              az rest --method delete --url "$DELETE_URL" || echo "  ‚ö†Ô∏è  Failed to delete $ITEM_ID"
            fi
          done
          
          # Step 4: Add/Update items from CSV
          echo "üìù Updating items from CSV..."
          tail -n +2 maintenance.csv | while IFS=, read -r hostname start_utc end_utc comment; do
            ITEM_ID=$(echo "$hostname" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
            
            echo "  Processing: $hostname"
            
            ITEM_URL="$BASE_URL/watchlistItems/$ITEM_ID?api-version=$API_VERSION"
            
            BODY=$(jq -n \
              --arg hostname "$hostname" \
              --arg start "$start_utc" \
              --arg end "$end_utc" \
              --arg comment "$comment" \
              '{
                properties: {
                  itemsKeyValue: {
                    hostname: $hostname,
                    start_utc: $start,
                    end_utc: $end,
                    comment: $comment
                  }
                }
              }')
            
            az rest --method put --url "$ITEM_URL" \
              --headers "Content-Type=application/json" \
              --body "$BODY" && echo "    ‚úÖ Done" || echo "    ‚ùå Failed"
          done
          
          echo "üéâ Full sync completed!"
